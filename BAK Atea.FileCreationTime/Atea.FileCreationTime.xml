<ManagementPack ContentReadable="true" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <Manifest>
    <Identity>
      <ID>Atea.FileCreationTime</ID>
      <Version>1.0.0.60</Version>
    </Identity>
    <Name>Atea.FileCreationTime</Name>
    <References>
      <Reference Alias="SC">
        <ID>Microsoft.SystemCenter.Library</ID>
        <Version>6.1.7221.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="Windows">
        <ID>Microsoft.Windows.Library</ID>
        <Version>6.1.7221.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="Health">
        <ID>System.Health.Library</ID>
        <Version>6.1.7221.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="System">
        <ID>System.Library</ID>
        <Version>6.1.7221.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="Performance">
        <ID>System.Performance.Library</ID>
        <Version>6.1.7221.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
    </References>
  </Manifest>
  <TypeDefinitions>
    <ModuleTypes>
      <DataSourceModuleType ID="Atea.FileCreationTime.Discovery.DataSource" Accessibility="Internal" Batching="false">
        <Configuration>
          <IncludeSchemaTypes>
            <SchemaType>Health!System.Health.AlertSchema</SchemaType>
          </IncludeSchemaTypes>
          <xsd:element minOccurs="1" name="MPElement" type="xsd:string" />
          <xsd:element minOccurs="1" name="TargetID" type="xsd:string" />
          <xsd:element minOccurs="1" name="ComputerName" type="xsd:string" />
          <xsd:element minOccurs="1" name="IntervalSeconds" type="xsd:integer" />
        </Configuration>
        <OverrideableParameters>
          <OverrideableParameter ID="IntervalSeconds" Selector="$Config/IntervalSeconds$" ParameterType="int" />
        </OverrideableParameters>
        <ModuleImplementation Isolation="Any">
          <Composite>
            <MemberModules>
              <DataSource ID="Scheduler" TypeID="System!System.Discovery.Scheduler">
                <Scheduler>
                  <SimpleReccuringSchedule>
                    <Interval>$Config/IntervalSeconds$</Interval>
                  </SimpleReccuringSchedule>
                  <ExcludeDates />
                </Scheduler>
              </DataSource>
              <ProbeAction ID="PoSHDiscovery" TypeID="Atea.FileCreationTime.ProbeAction.psFolderDiscovery">
                <MPElement>$Config/MPElement$</MPElement>
                <TargetID>$Config/TargetID$</TargetID>
                <ComputerName>$Config/ComputerName$</ComputerName>
              </ProbeAction>
            </MemberModules>
            <Composition>
              <Node ID="PoSHDiscovery">
                <Node ID="Scheduler" />
              </Node>
            </Composition>
          </Composite>
        </ModuleImplementation>
        <OutputType>System!System.Discovery.Data</OutputType>
      </DataSourceModuleType>
      <DataSourceModuleType ID="Atea.FileCreationTime.Monitoring.PropertyBag" Accessibility="Public" Batching="false">
        <Configuration>
          <xsd:element minOccurs="1" name="TimeOutSeconds" type="xsd:integer" />
          <xsd:element minOccurs="1" name="Interval" type="xsd:integer" />
          <xsd:element minOccurs="1" name="FolderFriendlyName" type="xsd:string" />
          <xsd:element minOccurs="1" name="Arguments" type="xsd:string" />
        </Configuration>
        <OverrideableParameters>
          <OverrideableParameter ID="TimeOutSeconds" Selector="$Config/TimeOutSeconds$" ParameterType="int" />
          <OverrideableParameter ID="IntervalSeconds" Selector="$Config/Interval$" ParameterType="int" />
        </OverrideableParameters>
        <ModuleImplementation Isolation="Any">
          <Composite>
            <MemberModules>
              <DataSource ID="Scheduler" TypeID="System!System.Scheduler">
                <Scheduler>
                  <SimpleReccuringSchedule>
                    <Interval>$Config/Interval$</Interval>
                  </SimpleReccuringSchedule>
                  <ExcludeDates />
                </Scheduler>
              </DataSource>
              <ProbeAction ID="Probe" TypeID="Atea.FileCreationTime.ProbeAction.vbsPropertyBag">
                <Arguments>$Config/Arguments$</Arguments>
                <TimeoutSeconds>$Config/TimeOutSeconds$</TimeoutSeconds>
              </ProbeAction>
              <ConditionDetection ID="Filter" TypeID="System!System.ExpressionFilter">
                <Expression>
                  <SimpleExpression>
                    <ValueExpression>
                      <XPathQuery>Property[@Name='FolderFriendlyName']</XPathQuery>
                    </ValueExpression>
                    <Operator>Equal</Operator>
                    <ValueExpression>
                      <Value>$Config/FolderFriendlyName$</Value>
                    </ValueExpression>
                  </SimpleExpression>
                </Expression>
              </ConditionDetection>
            </MemberModules>
            <Composition>
              <Node ID="Filter">
                <Node ID="Probe">
                  <Node ID="Scheduler" />
                </Node>
              </Node>
            </Composition>
          </Composite>
        </ModuleImplementation>
        <OutputType>System!System.PropertyBagData</OutputType>
      </DataSourceModuleType>
    </ModuleTypes>
  </TypeDefinitions>
  <Monitoring>
    <Discoveries>
      <Discovery ID="Atea.FileCreationTime.Folder.Discovery" Enabled="true" Target="Atea.FileCreationTime.Seed" ConfirmDelivery="true" Remotable="false" Priority="Normal">
        <Category>Discovery</Category>
        <DiscoveryTypes>
          <DiscoveryClass TypeID="Atea.FileCreationTime.Folder" />
        </DiscoveryTypes>
        <DataSource ID="DiscoveryDS" TypeID="Atea.FileCreationTime.Discovery.DataSource">
          <MPElement>$MPElement$</MPElement>
          <TargetID>$Target/Id$</TargetID>
          <ComputerName>$Target/Host/Property[Type="Windows!Microsoft.Windows.Computer"]/PrincipalName$</ComputerName>
          <IntervalSeconds>1440</IntervalSeconds>
        </DataSource>
      </Discovery>
      <Discovery ID="Atea.FileCreationTime.Seed.Discovery" Enabled="true" Target="Windows!Microsoft.Windows.Computer" ConfirmDelivery="false" Remotable="false" Priority="Normal">
        <Category>Discovery</Category>
        <DiscoveryTypes>
          <DiscoveryClass TypeID="Atea.FileCreationTime.Seed" />
        </DiscoveryTypes>
        <DataSource ID="DS" TypeID="Windows!Microsoft.Windows.FilteredRegistryDiscoveryProvider">
          <ComputerName>$Target/Property[Type="Windows!Microsoft.Windows.Computer"]/NetworkName$</ComputerName>
          <RegistryAttributeDefinitions>
            <RegistryAttributeDefinition>
              <AttributeName>FCKeyExist</AttributeName>
              <Path>SOFTWARE\Atea\FileCreationTime</Path>
              <PathType>0</PathType>
              <AttributeType>0</AttributeType>
            </RegistryAttributeDefinition>
          </RegistryAttributeDefinitions>
          <Frequency>14400</Frequency>
          <ClassId>$MPElement[Name="Atea.FileCreationTime.Seed"]$</ClassId>
          <InstanceSettings>
            <Settings>
              <Setting>
                <Name>$MPElement[Name="Windows!Microsoft.Windows.Computer"]/PrincipalName$</Name>
                <Value>$Target/Property[Type="Windows!Microsoft.Windows.Computer"]/PrincipalName$</Value>
              </Setting>
            </Settings>
          </InstanceSettings>
          <Expression>
            <SimpleExpression>
              <ValueExpression>
                <XPathQuery Type="String">Values/FCKeyExist</XPathQuery>
              </ValueExpression>
              <Operator>Equal</Operator>
              <ValueExpression>
                <Value Type="String">true</Value>
              </ValueExpression>
            </SimpleExpression>
          </Expression>
        </DataSource>
      </Discovery>
    </Discoveries>
    <Rules>
      <Rule ID="Atea.FileCreationTime.Folder.Alerting.Rule" Enabled="true" Target="Atea.FileCreationTime.Folder" ConfirmDelivery="true" Remotable="true" Priority="Normal" DiscardLevel="100">
        <Category>Alert</Category>
        <DataSources>
          <DataSource ID="DS" RunAs="Atea.FileCreationTime.FolderAccessAccount" TypeID="Atea.FileCreationTime.Monitoring.PropertyBag">
            <TimeOutSeconds>300</TimeOutSeconds>
            <Interval>300</Interval>
            <FolderFriendlyName>$Target/Property[Type="Atea.FileCreationTime.Folder"]/FriendlyName$</FolderFriendlyName>
            <Arguments>$Target/Host/Property[Type="Windows!Microsoft.Windows.Computer"]/NetworkName$</Arguments>
          </DataSource>
        </DataSources>
        <WriteActions>
          <WriteAction ID="WriteAlert" TypeID="Health!System.Health.GenerateAlert">
            <Priority>1</Priority>
            <Severity>1</Severity>
            <AlertMessageId>$MPElement[Name="Atea.FileCreationTime.Folder.Alerting.Rule.Message"]$</AlertMessageId>
            <AlertParameters>
              <AlertParameter1>$Data/Property[@Name='FileFullname']$</AlertParameter1>
              <AlertParameter2>$Data/Property[@Name='FileAgeMinutes']$</AlertParameter2>
              <AlertParameter3>$Data/Property[@Name='FolderFriendlyName']$</AlertParameter3>
              <AlertParameter4>$Data/Property[@Name='FileFullname']$</AlertParameter4>
              <AlertParameter5>$Target/Property[Type="Atea.FileCreationTime.Folder"]/FolderPath$</AlertParameter5>
              <AlertParameter6>$Target/Property[Type="Atea.FileCreationTime.Folder"]/Recursive$</AlertParameter6>
              <AlertParameter7>$Target/Property[Type="Atea.FileCreationTime.Folder"]/FilePattern$</AlertParameter7>
              <AlertParameter8>$Target/Property[Type="Atea.FileCreationTime.Folder"]/Operator$</AlertParameter8>
              <AlertParameter9>$Target/Property[Type="Atea.FileCreationTime.Folder"]/AgeInMinutes$</AlertParameter9>
            </AlertParameters>
            <Suppression>
              <SuppressionValue>$Data/Property[@Name='FileFullname']$</SuppressionValue>
              <SuppressionValue>$Data/Property[@Name='FolderFriendlyName']$</SuppressionValue>
            </Suppression>
          </WriteAction>
        </WriteActions>
      </Rule>
    </Rules>
  </Monitoring>
  <Presentation>
    <StringResources>
      <StringResource ID="Atea.FileCreationTime.Folder.Alerting.Rule.Message" />
      <StringResource ID="Atea.FileCreationTime.NewElement.AlertMessage" />
    </StringResources>
  </Presentation>
  <LanguagePacks>
    <LanguagePack ID="ENU" IsDefault="true">
      <DisplayStrings>
        <DisplayString ElementID="Atea.FileCreationTime.Discovery.DataSource">
          <Name>Atea File Creation Time Discovery Data Source</Name>
          <Description>This datasource provides the basic discovery data for the watched folders. </Description>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.Folder.Alerting.Rule">
          <Name>Atea File Creation Time Folder Alerting Rule</Name>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.Folder.Alerting.Rule.Message">
          <Name>File Creation Time alert has been triggered in {2}</Name>
          <Description>{0} was created {1} minutes ago in {2} which triggered this alert according to the configured query.
            Full Path to file is {3}

            Monitored folder: {4}
            Recursive check is: {5}

            Alerts will be triggered from this query:
            Filename = {6} where FileAge {7} {8} minutes</Description>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.Folder.Discovery">
          <Name>Atea File Creation Time Folder Discovery</Name>
          <Description />
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.FolderAccessAccount">
          <Name>Atea File Creation Time Folder Access Account</Name>
          <Description>Use this account to provide access to the folders where the regular RunAs account does not have privileges.</Description>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.Monitoring.PropertyBag">
          <Name>Atea File Creation Time Monitoring Property Bag</Name>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.NewElement.AlertMessage">
          <Name><![CDATA[as<zdxfcghvhb]]></Name>
          <Description>Event Description: {0}</Description>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.ProbeAction.psFolderDiscovery">
          <Name>Atea File Creation Time ProbeAction psFolderDiscovery</Name>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.Seed">
          <Name>Atea File Creation Time Seed</Name>
          <Description>Simple seed class for script based discovery targeting. Used to minimize overhead.</Description>
        </DisplayString>
        <DisplayString ElementID="Atea.FileCreationTime.Seed.Discovery">
          <Name>Atea File Creation Time Seed Discovery</Name>
        </DisplayString>
      </DisplayStrings>
    </LanguagePack>
  </LanguagePacks>
</ManagementPack>